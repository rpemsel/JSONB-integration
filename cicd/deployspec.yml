version: 0.2
env:
  shell: "bash"
  secrets-manager:
    KUBE_CONFIG: cicd-secrets:KUBE_CONFIG

phases:
  install:
    runtime-versions:
      java: corretto11
      python: 3.9
  pre_build:
    commands:
      - cp ./cicd/settings.xml ~/.m2/
      - export CODEARTIFACT_AUTH_TOKEN=`aws codeartifact get-authorization-token --domain artifact-repo --domain-owner 627739073141 --query authorizationToken --output text` && sed -i "s/env.CODEARTIFACT_AUTH_TOKEN/$CODEARTIFACT_AUTH_TOKEN/g" ~/.m2/settings.xml
      - curl https://baltocdn.com/helm/signing.asc | apt-key add -
      - apt-get install apt-transport-https --yes
      - echo "deb https://baltocdn.com/helm/stable/debian/ all main" | tee /etc/apt/sources.list.d/helm-stable-debian.list
      - apt-get update
      - apt-get install helm
      - docker build
  build:
    commands:
      - helm version
      - chmod 755 ./cicd/deploy.sh
      - mvn org.apache.maven.plugins:maven-dependency-plugin:2.1:get -Dartifact=com.jackis:jsonb-integration:1.0.0-SNAPSHOT
      - ls -lisah
      - ./cicd/deploy.sh